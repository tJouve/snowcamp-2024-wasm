<html>
  <head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href="my.css">
  </head>
    <!-- go -->
    <body>
        <h1>WASM Experiments</h1>
        <h2>ðŸ‘‹ Open the developer tools ðŸ˜ƒ</h2>
        <script> 
            // Load the wasm file
            let importObject = {
              wasi_snapshot_preview1: {
                fd_write: () => 0,
              }
            }

            WebAssembly.instantiateStreaming(fetch("main.wasm"), importObject) 
              .then(({ instance }) => {
                console.log("ðŸ“¦ Instance", instance)
                
                // Call the helloWorld TinyGo function
                // Get a kind of pair of values
                const resultPosSize = instance.exports.helloWorld();
                
                // Get pos and size of from result
                const MASK = (2n ** 32n) - 1n;
                // Extract the values of the pair (using the mask)
                const stringPos = Number(resultPosSize >> BigInt(32));
                const stringSize = Number(resultPosSize & MASK);
                
                console.log("ðŸ¤– Position:", stringPos);
                console.log("ðŸ¤– Size:", stringSize);
                
                // helloWorldPosSize:
                //  pos                              size
                // 110101âº000000000000000000000000âº10110100
                //
                // [shift right] helloWorldPosSize >> 32b
                //  pos                              
                // 110101âº
                //
                // [& mask] helloWorldPosSize & mask
                //  mask âº111111111111111111111111âº11111111
                //  pos                              size
                //       âº000000000000000000000000âº10110100
                
                // "Extract" the buffer 
                const memory = instance.exports.memory;
                const completeBufferFromMemory = new Uint8Array(memory.buffer);
                const extractedBuffer = completeBufferFromMemory.slice(
                  stringPos, stringPos + stringSize
                );
                console.log("ðŸ¤– extractedBuffer:", extractedBuffer)
                
                // Decode the buffer (to string)
                const str = new TextDecoder("utf8").decode(extractedBuffer)
                console.log("ðŸŽ‰", str)

              })
              .catch(error => {
                console.log("ðŸ˜¡ ouch", error)
              })
        </script>
  </body>
</html>
